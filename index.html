<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brownian Castle / Œ≤-Ballistic Deposition Simulator</title>
  <meta name="description" content="Interactive simulator for the Cannizzaro‚ÄìHairer Œ≤-ballistic deposition family and the 0-BD (Brownian Castle) regime." />

  <link rel="stylesheet" href="./styles.css" />

  <!-- KaTeX for readable math on the page -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"
          onload="renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}]});"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">üè∞</div>
      <div>
        <div class="title">Brownian Castle / Œ≤-Ballistic Deposition</div>
        <div class="subtitle">Interactive growth model simulator (static site ‚Äî perfect for GitHub Pages)</div>
      </div>
    </div>

    <div class="top-actions">
      <button id="btnPause" class="btn primary" type="button">Pause</button>
      <button id="btnStep" class="btn" type="button" title="Run a single animation step while paused">Step</button>
      <button id="btnReset" class="btn danger" type="button">Reset</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel viz" aria-label="Simulation canvas">
      <canvas id="canvas" width="1200" height="650"></canvas>

      <div class="hud" aria-live="polite">
        <div><span class="k">Mode</span> <span id="hudMode">Surface</span></div>
        <div><span class="k">Events</span> <span id="hudEvents">0</span></div>
        <div><span class="k">Sweeps</span> <span id="hudSweeps">0.0</span></div>
        <div><span class="k">Mean(h)</span> <span id="hudMean">0.0</span></div>
        <div><span class="k">Min/Max(h)</span> <span id="hudMinMax">0 / 0</span></div>
        <div><span class="k">FPS</span> <span id="hudFps">‚Äì</span></div>
      </div>

      <div class="viz-footer">
        <label class="toggle">
          <input id="toggleBrick" type="checkbox" />
          <span>Brick view (show last M updates as blocks)</span>
        </label>
        <label class="toggle">
          <input id="toggleSurface" type="checkbox" checked />
          <span>Surface profile overlay</span>
        </label>
      </div>
    </section>

    <aside class="panel controls" aria-label="Controls and explanation">
      <h2>Controls</h2>

      <div class="control">
        <label for="speed">Blocks / sec (simulation speed)</label>
        <div class="row">
          <input id="speed" type="range" min="1" max="6" step="0.01" value="4" />
          <output id="speedVal" class="mono">10,000</output>
        </div>
        <p class="hint">This controls how many deposition events are executed per real second (batched each frame).</p>
      </div>

      <div class="control">
        <label for="nSites">Columns (system size N)</label>
        <div class="row">
          <input id="nSites" type="range" min="32" max="2048" step="1" value="512" />
          <output id="nSitesVal" class="mono">512</output>
        </div>
        <p class="hint">We simulate on a periodic ring (no boundary artifacts).</p>
      </div>

      <div class="control">
        <label for="mBlocks">Blocks shown (M) ‚Äî for Brick view</label>
        <div class="row">
          <input id="mBlocks" type="range" min="200" max="50000" step="100" value="8000" />
          <output id="mBlocksVal" class="mono">8000</output>
        </div>
        <p class="hint">Brick view draws only the most recent M updates (constant memory).</p>
      </div>

      <div class="control">
        <label for="heightScale">Height scale (px per height unit)</label>
        <div class="row">
          <input id="heightScale" type="range" min="0.2" max="10" step="0.05" value="1.2" />
          <output id="heightScaleVal" class="mono">1.20</output>
        </div>
        <label class="toggle">
          <input id="autoScale" type="checkbox" checked />
          <span>Auto-scale height</span>
        </label>
      </div>

      <div class="control">
        <label for="beta">Inverse temperature Œ≤</label>
        <div class="row">
          <input id="beta" type="range" min="0" max="20" step="0.05" value="0" />
          <output id="betaVal" class="mono">0.00</output>
        </div>
        <label class="toggle">
          <input id="betaInf" type="checkbox" />
          <span>Œ≤ = ‚àû (deterministic max rule)</span>
        </label>
        <p class="hint">
          Œ≤=0 is the <b>0-BD</b> regime (the paper‚Äôs Brownian Castle scaling limit is proved here). Large Œ≤ approaches classical ballistic deposition.
        </p>
      </div>

      <details class="advanced">
        <summary>Advanced (math fidelity knobs)</summary>

        <div class="control">
          <label class="toggle">
            <input id="usePaperRates" type="checkbox" checked />
            <span>Use 0-BD ‚Äúpaper normalisation‚Äù (rL=rR=1, rC=2)</span>
          </label>
          <p class="hint">
            In 0-BD the authors use a graphical construction with three Poisson processes (left/right arrows and dots) with intensities proportional to 1/2, 1/2, and 1.
            Setting base rates (1,2,1) reproduces those relative frequencies when Œ≤=0.
          </p>
        </div>

        <div class="control">
          <label class="toggle">
            <input id="subtractDrift" type="checkbox" checked />
            <span>Subtract mean growth (centering)</span>
          </label>
          <p class="hint">
            For Brownian-Castle scaling pictures you typically subtract a linear drift in time. Here we subtract the spatial mean height each frame (empirical centering).
          </p>
        </div>

        <div class="control">
          <label for="seed">Random seed</label>
          <div class="row">
            <input id="seed" type="text" value="castle" spellcheck="false" />
            <button id="btnReseed" class="btn" type="button">Reseed</button>
          </div>
          <p class="hint">Same seed ‚áí same randomness ‚áí reproducible demos in talks.</p>
        </div>

        <div class="control">
          <label class="toggle">
            <input id="exactClocks" type="checkbox" />
            <span>Exact continuous time (Gillespie) instead of event-count time</span>
          </label>
          <p class="hint">
            If enabled, we sample waiting times Œît ~ Exp(N) between events. Otherwise we treat time as ‚Äúsweeps‚Äù = events/N.
          </p>
        </div>
      </details>

      <hr />

      <h2>Mathematics implemented</h2>
      <div class="mathbox">
        <p>
          Heights live on a 1D lattice: $h:\mathbb{Z}\to\mathbb{Z}$. When site $x$ ‚Äúrings‚Äù, consider three candidates:
        </p>
        <p class="eq">
          $y_L = h(x-1),\quad y_C = h(x)+1,\quad y_R = h(x+1)$.
        </p>
        <p>
          We sample one of them using a soft-max (finite temperature) rule:
        </p>
        <p class="eq">
          $\mathbb{P}(y=y_i)=\dfrac{r_i e^{\beta y_i}}{\sum_{j\in\{L,C,R\}} r_j e^{\beta y_j}}.$
        </p>
        <p>
          Then we set $h(x)\leftarrow y$. In the limit $\beta\to\infty$ this concentrates on the maximum and matches classical ballistic deposition
          $h(x)\mapsto\max\{h(x-1),h(x)+1,h(x+1)\}$.
        </p>
      </div>

      <div class="footer">
        <p class="small">
          Notes: This simulator implements the microscopic Markov dynamics (the deposition rule) directly. The Brownian Castle is a scaling limit proved for 0-BD (Œ≤=0).
          Large N and longer runs show the ‚Äúturrets and crannies‚Äù structure more clearly.
        </p>
      </div>
    </aside>
  </main>

  <script type="module" src="./app.js"></script>
</body>
</html>